<div class="p-6 bg-[#60A3D9] min-h-screen">
  <h2 class="text-2xl font-semibold mb-4">üîÆ Apprentissage supervis√©</h2>

  <!-- actions -->
  <div class="flex items-center flex-wrap gap-3 mb-4">
    <input type="file" (change)="onFileChange($event)" accept=".csv" class="border p-2 rounded" />
    <button (click)="train()" [disabled]="!file || training"
            class="bg-purple-600 text-white px-3 py-2 rounded disabled:opacity-50">
      {{ training ? 'Entra√Ænement...' : 'Entra√Æner mod√®le (CSV)' }}
    </button>

    <button (click)="predictOnCurrentStagiaires()" [disabled]="predicting"
            class="bg-blue-600 text-white px-3 py-2 rounded disabled:opacity-50">
      {{ predicting ? 'Pr√©diction...' : 'Pr√©dire les stagiaires actuels' }}
    </button>

    <button (click)="exportCsv()" [disabled]="!results.length"
            class="bg-green-600 text-white px-3 py-2 rounded disabled:opacity-50">
      Exporter CSV
    </button>
  </div>

  <!-- charger stats DB -->
  <div class="mt-2 mb-4">
    <button (click)="loadDbStats()" [disabled]="dbLoading"
            class="bg-gray-800 text-white px-3 py-2 rounded disabled:opacity-50">
      {{ dbLoading ? 'Chargement‚Ä¶' : 'üìä Charger les stats depuis la DB' }}
    </button>
    <span *ngIf="dbError" class="text-red-600 ml-2">‚ö† {{ dbError }}</span>
  </div>

  <!-- messages -->
  <div *ngIf="errorMsg" class="bg-red-100 text-red-700 p-3 rounded mb-4">{{ errorMsg }}</div>
  <div *ngIf="metrics" class="bg-green-100 text-green-800 p-3 rounded mb-4">
    Mod√®le entra√Æn√©. <span *ngIf="metrics?.n">n = {{ metrics.n }}</span>
  </div>

  <!-- KPI -->
  <div *ngIf="!dbLoading && !dbError && kpi?.total"
       class="grid grid-cols-1 md:grid-cols-4 gap-3 my-4 kpi-grid">
    <div class="bg-white rounded shadow p-3">
      <div class="text-gray-500">Total stagiaires</div>
      <div class="text-2xl font-semibold">{{ kpi.total }}</div>
    </div>
    <div class="bg-white rounded shadow p-3">
      <div class="text-gray-500">Actifs aujourd‚Äôhui</div>
      <div class="text-2xl font-semibold">{{ kpi.actifs }}</div>
    </div>
    <div class="bg-white rounded shadow p-3">
      <div class="text-gray-500">Dur√©e moyenne (j)</div>
      <div class="text-2xl font-semibold">{{ kpi.avg }}</div>
    </div>
    <div class="bg-white rounded shadow p-3">
      <div class="text-gray-500">Top institut</div>
      <div class="text-xl font-semibold">{{ kpi.topInstitut }}</div>
    </div>
  </div>

  <!-- charts -->
  <div *ngIf="barLabels?.length || pieSpecLabels?.length"
       class="grid grid-cols-1 md:grid-cols-2 gap-3 my-4 charts-grid">
    <div class="bg-white rounded shadow p-3 chart-card">
      <h4 class="font-medium mb-2">Top instituts</h4>
      <canvas baseChart [datasets]="barData" [labels]="barLabels"
              [options]="chartOpts" [legend]="true" [chartType]="'bar'"></canvas>
    </div>
    <div class="bg-white rounded shadow p-3 chart-card">
      <h4 class="font-medium mb-2">Top sp√©cialit√©s</h4>
      <canvas baseChart [data]="pieSpecData" [labels]="pieSpecLabels"
              [options]="chartOpts" [legend]="true" [chartType]="'pie'"></canvas>
    </div>
  </div>

  <!-- r√©sultats pr√©diction -->
  <div *ngIf="results?.length">
    <h3 class="text-lg font-medium mb-2">R√©sultats ({{ results.length }})</h3>
    <div class="overflow-auto">
      <table class="min-w-full text-sm border">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">CIN</th>
            <th class="p-2 border">Nom</th>
            <th class="p-2 border">Pr√©nom</th>
            <th class="p-2 border">Pr√©diction</th>
            <th class="p-2 border">Top prob.</th>
            <th class="p-2 border">√Ä revoir?</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of results">
            <td class="p-2 border">{{ r.cin }}</td>
            <td class="p-2 border">{{ r.nom }}</td>
            <td class="p-2 border">{{ r.prenom }}</td>
            <td class="p-2 border font-semibold">{{ r.prediction }}</td>
            <td class="p-2 border">{{ r.top_prob ? (r.top_prob | number:'1.2-2') : '' }}</td>
            <td class="p-2 border">{{ r.flag_review ? 'Oui' : 'Non' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <a routerLink="/gestion-stagiaires" class="inline-block mt-6 text-blue-700 underline">‚Üê Retour</a>
</div>
