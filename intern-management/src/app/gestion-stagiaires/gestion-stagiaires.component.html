<div class="flex min-h-screen bg-[#60A3D9] font-sans text-gray-100">

  <!-- Sidebar -->
  <nav class="bg-[#1f2937] w-48 flex flex-col p-6 space-y-6 text-white">
    <div class="font-bold text-white text-lg">STEG Admin</div>

   <a class="flex items-center space-x-2 text-gray-400 hover:text-white"
   [routerLink]="['/stat']"
   routerLinkActive="text-white">
  <i class="fas fa-chart-bar"></i>
  <span>Statistiques</span>
  </a>

    
    <a class="flex items-center space-x-2 text-white font-semibold bg-[#374151] rounded px-2 py-1" href="#">
      <i class="fas fa-users"></i>
      <span>Gestion des stagiaires</span>
    </a>
    <a class="flex items-center space-x-2 text-red-600 hover:text-red-400" href="#">
      <i class="fas fa-sign-out-alt"></i>
      <span>Deconnexion</span>
    </a>
  </nav>

  <!-- Main content -->
  <main class="flex-1 p-6">

    <!-- Header -->
    <div class="bg-[#f8f8f8] rounded-md flex items-center justify-between px-6 py-3 mb-6" style="min-width:600px">
      <img alt="Drapeau tunisien" class="h-5 w-auto" src="assets/flag.png" />
      <h1 class="text-center text-gray-800 font-semibold text-lg flex-1">Gestion Des Stagiaires</h1>
      <img alt="Logo circulaire" class="h-7 w-auto" src="assets/logo.png" />
    </div>

    <!-- Buttons -->
    <div class="flex space-x-3 mb-6 justify-center">
      <button class="bg-green-500 hover:bg-green-600 text-white text-xs font-normal rounded px-3 py-1"
              [routerLink]="['/ajouter-stagiaire']">+ Ajouter stagiaire</button>
      <button class="bg-gray-700 hover:bg-gray-800 text-white text-xs font-normal rounded px-3 py-1"
              (click)="printPage()">üñ® Imprimer</button>
    </div>

    <!-- Search bar -->
    <form class="flex justify-center mb-3" style="min-width:600px" (ngSubmit)="rechercher()">
      <div class="flex w-full max-w-xl rounded-md overflow-hidden">
        <span class="flex items-center justify-center bg-[#f8f8f8] border border-r-0 border-gray-300 px-3 text-gray-400">
          <i class="fas fa-search"></i>
        </span>
        <input id="searchBox"
               class="flex-grow px-3 py-1 border border-l-0 border-gray-300 rounded-r-md text-xs text-gray-400 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 bg-white"
               placeholder="Recherche globale (CIN, nom, email, etc.)"
               type="text"
               [(ngModel)]="recherche"
               name="recherche"/>
        <button class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-normal px-3 rounded-r-md" type="submit">Rechercher</button>
        <button class="bg-gray-400 hover:bg-gray-500 text-white text-xs font-normal px-3 ml-2 rounded-md" type="button" (click)="effacerRecherche()">Effacer</button>
      </div>
    </form>

    <!-- Filter bar -->
    <div class="flex flex-wrap gap-3 justify-center mb-4 max-w-4xl mx-auto">
      <select [(ngModel)]="filterInstitut" name="filterInstitut" class="px-2 py-1 border rounded text-xs bg-white border-gray-300 text-gray-700"
              (ngModelChange)="page = 1; onFilterChange()"
              (change)="onFilterChange()">
        <option value="">Tous les instituts</option>
        <option *ngFor="let inst of uniqueInstituts" [value]="inst">{{ inst }}</option>
      </select>
      <select [(ngModel)]="filterSpecialite" name="filterSpecialite" class="px-2 py-1 border rounded text-xs bg-white border-gray-300 text-gray-700"
              (ngModelChange)="page = 1; onFilterChange()"
              (change)="onFilterChange()">
        <option value="">Toutes les sp√©cialit√©s</option>
        <option *ngFor="let sp of uniqueSpecialites" [value]="sp">{{ sp }}</option>
      </select>
      <button type="button" (click)="clearFilters(); page = 1"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 text-xs font-normal rounded px-3 py-1">
        R√©initialiser filtres
      </button>
    </div>

    <!-- Export buttons -->
    <div class="flex justify-center gap-3 mb-4">
      <button (click)="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">Export CSV</button>
      <button (click)="exportExcel()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded">Export Excel</button>
      <button (click)="exportPDF()" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded">Export PDF</button>
    </div>

    <!-- Status messages -->
    <div *ngIf="loading" class="text-center text-gray-700 mb-4">‚è≥ Chargement...</div>
    <div *ngIf="error" class="text-center text-red-600 mb-4">{{ error }}</div>

    <!-- Table -->
    <div class="overflow-x-auto rounded-md" style="min-width:600px" *ngIf="filteredStagiaires.length > 0 && !loading">
      <table class="min-w-full text-xs text-left text-gray-700 rounded-md overflow-hidden">
        <thead class="bg-[#4a6ea9] text-white sticky top-0">
          <tr>
            <th class="px-2 py-1 border cursor-pointer" (click)="sortBy('cin')">CIN</th>
            <th class="px-2 py-1 border cursor-pointer" (click)="sortBy('nom')">NOM</th>
            <th class="px-2 py-1 border cursor-pointer" (click)="sortBy('prenom')">PRENOM</th>
            <th class="px-2 py-1 border">EMAIL</th>
            <th class="px-2 py-1 border">TELEPHONE</th>
            <th class="px-2 py-1 border">INSTITUT</th>
            <th class="px-2 py-1 border">SPECIALITE</th>
            <th class="px-2 py-1 border">QR</th>
            <th class="px-2 py-1 border">ACTIONS</th>
          </tr>
        </thead>
        <tbody class="bg-white text-gray-700">
          <tr *ngFor="let stagiaire of pagedStagiaires; let i = index">
            <td class="px-2 py-1 border">{{ stagiaire.cin }}</td>
            <td class="px-2 py-1 border">{{ stagiaire.nom }}</td>
            <td class="px-2 py-1 border">{{ stagiaire.prenom }}</td>
            <td class="px-2 py-1 border group">
              {{ stagiaire.email }}
              <button type="button" class="ml-1 text-blue-600 underline text-[10px] opacity-0 group-hover:opacity-100"
                      (click)="copy(stagiaire.email)">Copier</button>
            </td>
            <td class="px-2 py-1 border group">
              {{ stagiaire.telephone }}
              <button type="button" class="ml-1 text-blue-600 underline text-[10px] opacity-0 group-hover:opacity-100"
                      (click)="copy(stagiaire.telephone)">Copier</button>
            </td>
            <td class="px-2 py-1 border">{{ stagiaire.institut }}</td>
            <td class="px-2 py-1 border">{{ stagiaire.specialite }}</td>
            <td class="px-2 py-1 border">
              <img [src]="qrMap.get(stagiaire.cin) || ''" alt="QR" width="48" height="48" class="cursor-pointer"
                   (click)="openQR(qrMap.get(stagiaire.cin) || '')">
            </td>
            <td class="px-2 py-1 border space-x-2">
              <button [routerLink]="['/modify-intern', stagiaire.id]" class="bg-yellow-500 text-white px-2 py-1 rounded">Modifier</button>
              <button (click)="supprimerStagiaire(i)" class="bg-red-500 text-white px-2 py-1 rounded">Supprimer</button>
              <button [routerLink]="['/attestation-form']"
                      [queryParams]="{ cin: stagiaire.cin, nom: stagiaire.nom, prenom: stagiaire.prenom, institut: stagiaire.institut, dateDebut: stagiaire.date_debut, dateFin: stagiaire.date_fin, objetStage: stagiaire.objet_stage }"
                      class="bg-blue-500 text-white px-2 py-1 rounded">Attestation</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination controls -->
    <div *ngIf="!loading && filteredStagiaires.length > 0" class="max-w-4xl mx-auto mt-3 flex items-center justify-between gap-3">
      <!-- Pagination logic ici -->
    </div>

    <!-- No data -->
    <div *ngIf="filteredStagiaires.length === 0 && !loading && !error" class="text-center text-gray-600">
      Aucun stagiaire trouv√©.
    </div>

    <!-- Toast -->
    <div *ngIf="toast" class="fixed bottom-4 right-4 bg-black text-white text-xs px-3 py-2 rounded shadow">
      {{ toast }}
    </div>

    <!-- QR modal -->
    <div *ngIf="qrPreview" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
      <div class="bg-white p-4 rounded shadow">
        <img [src]="qrPreview" alt="QR" class="w-64 h-64 mx-auto">
        <button (click)="closeQR()" class="mt-3 bg-red-500 text-white px-3 py-1 rounded">Fermer</button>
      </div>
    </div>

  </main>
  <app-chatbot></app-chatbot>

</div>
